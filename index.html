<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>V√§rldens b√§sta SMS-Spamfilter ‚Äì Mystiska edition</title>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root {
      --bg: #f8f9ff;
      --card: #ffffff;
      --primary: #7c3aed;
      --primary-dark: #6d28d9;
      --success: #10b981;
      --danger: #ef4444;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
    }

    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(to bottom, #f3e8ff, var(--bg));
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, #4c1d95, #7c3aed);
      color: white;
      text-align: center;
      padding: 3.5rem 1rem 2.5rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }

    h1 {
      font-size: 2.8rem;
      margin-bottom: 0.4rem;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    header p { font-size: 1.15rem; opacity: 0.92; }

    main {
      max-width: 960px;
      margin: -4rem auto 3rem;
      padding: 0 1rem;
    }

    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 1.8rem;
      box-shadow: 0 12px 35px rgba(0,0,0,0.1);
      backdrop-filter: blur(8px);
    }

    h2 { color: var(--primary-dark); margin-bottom: 1rem; }

    textarea {
      width: 100%;
      min-height: 140px;
      padding: 1rem;
      font-size: 1.05rem;
      border: 2px solid var(--border);
      border-radius: 12px;
      resize: vertical;
      transition: 0.2s;
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(124,58,237,0.15);
    }

    .controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      margin: 1.2rem 0;
      align-items: center;
    }

    button {
      padding: 0.9rem 1.8rem;
      font-size: 1.05rem;
      border-radius: 999px;
      border: none;
      background: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    button:hover:not(:disabled) {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    button:disabled { opacity: 0.55; cursor: not-allowed; }

    #status { color: var(--muted); font-style: italic; }

    #result {
      margin-top: 1.5rem;
      padding: 1.4rem;
      border-radius: 12px;
      font-family: ui-monospace, monospace;
      background: #f9fafb;
      white-space: pre-wrap;
      line-height: 1.5;
    }

    .spam { background: #fee2e2; color: var(--danger); border-left: 6px solid var(--danger); }
    .ham  { background: #ecfdf5; color: var(--success); border-left: 6px solid var(--success); }

    .tokens {
      margin-top: 1.5rem;
      font-size: 0.95rem;
      color: #4b5563;
    }

    .tokens strong { color: var(--primary-dark); }

    footer {
      text-align: center;
      padding: 2rem 1rem;
      color: #6b7280;
      font-size: 0.95rem;
      border-top: 1px solid var(--border);
    }
  </style>
</head>
<body>

<header>
  <h1>üåç V√§rldens b√§sta SMS-Spamfilter</h1>
  <p>TensorFlow.js ‚Ä¢ K√∂rs helt i webbl√§saren ‚Ä¢ Mystiska edition üöÄ</p>
</header>

<main>
  <div class="card">
    <h2>Testa ett engelskt SMS</h2>
    <p>Skriv in ett meddelande p√• engelska (modellen √§r tr√§nad p√• engelska SMS).</p>

    <textarea id="input" placeholder="Exempel: WINNER! You are selected for a FREE iPhone! Click here to claim now..."></textarea>

    <div class="controls">
      <button id="btnPredict" disabled>
        <i class="fas fa-bolt"></i> Analysera med v√§rldens b√§sta detektor
      </button>
      <span id="status">Laddar modell och vokabul√§r‚Ä¶</span>
    </div>

    <div id="result">V√§ntar p√• analys‚Ä¶</div>

    <div class="tokens">
      <strong>Anv√§nda tokens:</strong><br>
      <span id="tokensOutput">‚Äî</span>
    </div>
  </div>
</main>

<footer>
  Skapad med ‚ù§Ô∏è av Mystiska ‚Ä¢ Baserad p√• TensorFlow.js ‚Ä¢ 2026 edition
</footer>

<script>
let model = null;
let wordIndex = null;
let maxLen = 30;       // fallback ‚Äì uppdateras fr√•n modellen
let oovToken = 1;      // vanlig standard f√∂r <OOV>

const MODEL_PATH = "./tfjs_model/model.json";
const META_PATH  = "./tfjs_model/metadata.json";

const btnPredict   = document.getElementById("btnPredict");
const inputEl      = document.getElementById("input");
const resultEl     = document.getElementById("result");
const statusEl     = document.getElementById("status");
const tokensOutput = document.getElementById("tokensOutput");

async function loadModelAndMetadata() {
  try {
    statusEl.textContent = "Laddar modell‚Ä¶";

    // Ladda metadata f√∂rst (billigare √§n modell)
    const metaRes = await fetch(META_PATH + "?v=" + Date.now());
    if (!metaRes.ok) throw new Error(`metadata.json: ${metaRes.status}`);
    const meta = await metaRes.json();
    wordIndex = meta.word_index || meta.wordIndex;
    if (!wordIndex) throw new Error("Ingen word_index hittad i metadata");

    // Ladda modell
    model = await tf.loadLayersModel(MODEL_PATH + "?v=" + Date.now());
    maxLen = model.inputs[0].shape[1] ?? 30;

    // Hitta OOV-token om det heter n√•got annat
    oovToken = wordIndex["<OOV>"] ?? wordIndex["<unk>"] ?? wordIndex["unk"] ?? 1;

    // V√§rm upp modellen (f√∂rsta prediktionen √§r l√•ngsammare)
    const dummy = tf.zeros([1, maxLen], "int32");
    model.predict(dummy).dispose();
    dummy.dispose();

    statusEl.textContent = "V√§rldens b√§sta detektor redo! üéâ";
    btnPredict.disabled = false;
  } catch (err) {
    console.error(err);
    statusEl.innerHTML = `<span style="color:var(--danger)">Fel: ${err.message}</span>`;
    resultEl.innerHTML = "Kunde inte ladda modellen. Kontrollera att tfjs_model/ finns p√• servern.";
  }
}

function cleanAndTokenize(text) {
  return text.toLowerCase()
    .replace(/[^\w\s']/g, " ")     // beh√•ll bara bokst√§ver, siffror, space, '
    .replace(/\s+/g, " ")
    .trim()
    .split(" ");
}

function textToSequence(text) {
  const tokens = cleanAndTokenize(text);
  const seq = new Array(maxLen).fill(0);

  // Fyll fr√•n slutet (senaste orden viktigast f√∂r m√•nga spam-modeller)
  const startIdx = Math.max(0, maxLen - tokens.length);
  for (let i = 0; i < tokens.length && startIdx + i < maxLen; i++) {
    seq[startIdx + i] = wordIndex[tokens[i]] ?? oovToken;
  }

  return seq;
}

btnPredict.onclick = async () => {
  const text = inputEl.value.trim();
  if (!text) {
    resultEl.textContent = "Skriv n√•got f√∂rst!";
    return;
  }

  resultEl.textContent = "Analyserar‚Ä¶";
  tokensOutput.textContent = "‚Ä¶";

  try {
    const seq = textToSequence(text);
    const tensor = tf.tensor2d([seq], [1, maxLen], "int32");
    const pred = model.predict(tensor);
    const prob = (await pred.data())[0];

    tensor.dispose();
    pred.dispose();

    const isSpam = prob >= 0.5;
    resultEl.className = isSpam ? "result spam" : "result ham";
    resultEl.innerHTML = `
Spam-sannolikhet: <strong>${(prob * 100).toFixed(1)} %</strong>
Klass: ${isSpam ? "SPAM ‚ö†Ô∏è" : "HAM ‚úÖ"}

Originaltext: "${text.slice(0,120)}${text.length>120?"‚Ä¶":""}"
    `;

    // Visa tokens snyggt
    const usedTokens = [];
    seq.forEach((id, i) => {
      if (id !== 0) {
        const word = Object.keys(wordIndex).find(k => wordIndex[k] === id) || `?${id}`;
        usedTokens.push(`${word} ‚Üí ${id}`);
      }
    });
    tokensOutput.textContent = usedTokens.length ? usedTokens.join(" ‚Ä¢ ") : "Inga matchande ord";
  } catch (err) {
    resultEl.textContent = `Fel vid analys: ${err.message}`;
  }
};

// Starta automatiskt
loadModelAndMetadata();
</script>
</body>
</html>
