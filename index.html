<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spamfilter – Test</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 40px; background: #f8f9fa; }
    h1 { color: #333; }
    textarea { width: 90%; max-width: 600px; height: 120px; padding: 12px; font-size: 16px; margin: 20px; }
    button { padding: 14px 40px; font-size: 18px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; }
    button:disabled { background: gray; }
    #resultat { font-size: 24px; margin: 30px; padding: 15px; border-radius: 8px; background: #e9ecef; }
    #debug { margin: 40px auto; max-width: 800px; border: 1px solid #ccc; padding: 15px; background: white; text-align: left; font-family: monospace; max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>

  <h1>Spam/Ham-detektering – Testläge</h1>
  <p>Skriv ett meddelande och klicka. Om ingenting händer efter 5 sek → kolla debug + console.</p>

  <textarea id="inputText" placeholder="Ex: Grattis du har vunnit! Klicka här för att hämta priset..."></textarea><br>

  <button id="btn" onclick="predictSpam()">Klassificera</button>

  <div id="resultat">Väntar...</div>

  <div id="debug"><strong>Debug:</strong><br></div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>

  <script>
    alert("JavaScript körs! (test-alert)");  // ← Ta bort denna rad senare om du vill

    const debug = document.getElementById('debug');
    function log(msg, err = false) {
      debug.innerHTML += (err ? '[FEL] ' : '') + msg + '<br>';
      debug.scrollTop = debug.scrollHeight;
    }

    log("Sidan laddad – JS startade " + new Date().toLocaleTimeString());

    const modelUrl = 'https://raw.githubusercontent.com/mystiskahackaren/spamfilter/main/tfjs_model/model.json';
    const metaUrl  = 'https://raw.githubusercontent.com/mystiskahackaren/spamfilter/main/tfjs_model/metadata.json';

    let model = null;
    let wordIndex = null;
    let maxLen = 30;
    let oov = 1;
    const labels = ['ham', 'spam'];

    async function loadStuff() {
      try {
        log("Laddar metadata...");
        const metaRes = await fetch(metaUrl);
        if (!metaRes.ok) throw new Error("Metadata HTTP " + metaRes.status);
        const meta = await metaRes.json();
        wordIndex = meta.word_index;
        maxLen = meta.max_length || 30;
        if (meta.oov_token) oov = wordIndex[meta.oov_token] || 1;
        log(`OK – vocab: ${Object.keys(wordIndex).length} ord, maxLen: ${maxLen}`);

        log("Laddar modell...");
        model = await tf.loadLayersModel(modelUrl);
        log("Modell laddad! Input: " + model.inputs[0].shape);
      } catch (e) {
        log("Laddningsfel: " + e.message, true);
        console.error(e);
      }
    }

    async function predictSpam() {
      const text = document.getElementById('inputText').value.trim();
      if (!text) return alert("Skriv något först!");

      const btn = document.getElementById('btn');
      btn.disabled = true;
      document.getElementById('resultat').innerHTML = "Bearbetar...";

      try {
        if (!model || !wordIndex) await loadStuff();

        const tokens = text.toLowerCase()
          .replace(/[^\w\s]/g, '')
          .split(/\s+/)
          .map(w => wordIndex[w] || oov)
          .slice(0, maxLen);

        while (tokens.length < maxLen) tokens.push(0);

        const input = tf.tensor2d([tokens], [1, maxLen]);
        const out = model.predict(input);
        const prob = (await out.data())[0];
        const isSpam = prob > 0.5;

        let msg = isSpam ? '<span style="color:red">SPAM</span>' : '<span style="color:green">HAM</span>';
        msg += ` (sannolikhet spam: ${(prob*100).toFixed(1)}%)`;

        document.getElementById('resultat').innerHTML = msg;
        log("Prediktion klar: " + msg.replace(/<[^>]+>/g, ''));

        input.dispose(); out.dispose();
      } catch (e) {
        document.getElementById('resultat').innerHTML = "Fel – se debug";
        log("Prediktionsfel: " + e.message, true);
        console.error(e);
      } finally {
        btn.disabled = false;
      }
    }

    // Kör en gång vid start
    loadStuff().catch(e => log("Auto-laddning misslyckades: " + e.message, true));
  </script>

</body>
</html>
